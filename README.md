# Lotto Simulator

한국 로또 6/45 시스템을 시뮬레이션하는 멀티모듈 백엔드 프로젝트입니다.

---

## 프로젝트 개요

실제 로또 시스템의 핵심 요소들을 분산 아키텍처로 구현하는 학습 프로젝트입니다.  
중앙 관리, POS 터미널, 자동화 봇, 실시간 모니터링으로 구성된 시스템을 설계하고 구현합니다.

---

## 시스템 구조

```
lotto-simulator/
├── lotto-core/            # 공통 도메인 모델 및 유틸리티
├── lotto-central-server/  # 중앙 관리 서버 (8100)
├── lotto-pos-manager/     # POS 풀 관리자 (8300)
├── lotto-pos-terminal/    # 구매 처리 워커 (8400+)
├── lotto-bot-client/      # 자동 구매 봇 (8200)
├── lotto-dashboard/       # 실시간 모니터링 (8500)
└── docs/                  # 설계 문서
```

### 모듈 간 통신 구조

```
Dashboard (8500)
     ↑ SSE
     │
Central Server (8100) ← PostgreSQL
     ↑ API
     │
Bot Client (8200) ← 구매 요청
     ↓ 할당
POS Manager (8300) ← 풀 관리
     ↓ 터미널 제공
POS Terminal (8400+) ← 실제 구매
```

---

## 핵심 설계

### 중앙 서버
- 회차 생명주기 관리 (오픈 → 진행 중 → 추첨 → 완료)
- 당첨 번호 생성 및 당첨 판정
- 티켓 데이터 영속화
- 통계 데이터 제공

### POS 시스템
**Manager (풀 관리)**
- 사용 가능한 터미널 풀 유지
- 터미널 할당 및 회수
- 컨테이너 헬스체크 및 재생성

**Terminal (구매 워커)**
- 중앙 서버 API 호출
- 오너 정보 관리
- 응답시간 수집

### 봇 클라이언트
- 봇 인스턴스 생명주기 관리
- 구매 스케줄링 및 실행
- POS 연결 상태 추적
- 장애 감지 및 재할당

### 대시보드
- 실시간 시스템 상태 (SSE)
- 구매 현황 시각화
- 통계 및 모니터링

---

## 기술 스택

### 백엔드
- **언어**: Java 21
- **프레임워크**: Spring Boot 3.4.0
- **빌드**: Gradle (Kotlin DSL)
- **ORM**: Spring Data JPA

### 데이터베이스
- **Central Server**: PostgreSQL 16
- **Bot Client**: H2 (인메모리)

### 인프라
- **컨테이너**: Docker & Docker Compose
- **빌드 자동화**: Makefile

---

## 문서

### 모듈별 가이드
각 모듈 디렉토리의 README에서 상세 설계를 확인할 수 있습니다.

### 개발 가이드 (추가 예정)
- 빌드 가이드
- 코딩 표준
- 설계 문서

---

## 실행 방법

### 필수 요구사항
- Java 21
- Docker & Docker Compose  
- Make

### 빌드 및 실행

```bash
# 전체 시스템 빌드 및 실행
make up

# 로그 확인
make logs

# 종료
make down

# 완전 초기화 (볼륨 포함)
make clean
```

Makefile의 상세 명령어는 향후 추가될 빌드 가이드를 참고하세요.

---

## 개발 진행 상황

### 완료
- [x] 멀티모듈 프로젝트 구조
- [x] Gradle 빌드 환경
- [x] Docker Compose 설정
- [x] 아키텍처 설계

### 개발 중

#### lotto-core (공통 라이브러리)
- [x] 로또 번호 도메인 모델
  - [x] 1-45 범위 검증
  - [x] 중복 검증
  - [x] 불변성 보장
- [x] 티켓 도메인 모델
  - [x] 고정 6개 번호 관리
  - [x] 정렬 상태 유지
- [x] 당첨 등수 판정 로직
  - [x] 일치 개수 계산
  - [x] 보너스 번호 처리
- [x] 공통 예외 정의
- [x] API 응답 포맷

#### lotto-central-server (중앙 서버)
- [x] 회차 관리
  - [x] 회차 생성 및 상태 관리
  - [x] 추첨 스케줄링
  - [x] 회차 전환 로직
- [x] 당첨 번호 생성
  - [x] 무작위 번호 생성
  - [x] 중복 없는 6개 선택
  - [x] 보너스 번호 선택
- [x] 티켓 구매 처리
  - [x] 구매 요청 검증
  - [x] 티켓 번호 발행
  - [x] 데이터베이스 저장
- [x] 당첨 판정
  - [x] 전체 티켓 대상 판정
  - [x] 등수별 집계
  - [x] 당첨 금액 계산
- [ ] 통계 API
  - [ ] 회차별 통계
  - [ ] 번호별 출현 빈도
  - [ ] 구매 현황
- [ ] 봇 관리 API
  - [ ] 봇 생성 및 비활성화
  - [ ] POS 할당 정보 관리
  - [ ] 활성 봇 조회
- [x] 데이터베이스 스키마
  - [x] 회차 테이블
  - [x] 티켓 테이블
  - [ ] 봇 테이블
  - [ ] POS 테이블

#### lotto-bot-client (봇 클라이언트)
- [ ] 봇 인스턴스 관리
  - [ ] 인스턴스 생명주기
  - [ ] 메모리 저장소
  - [ ] 최대 개수 제한
- [ ] 구매 스케줄링
  - [ ] 주기적 구매 실행
  - [ ] 설정 기반 인터벌
  - [ ] 티켓 수량 제어
- [ ] POS 연결 관리
  - [ ] 연결 정보 저장
  - [ ] 상태 추적
  - [ ] 복수 POS 지원
- [ ] 헬스체크 (봇 → POS)
  - [ ] 주기적 상태 확인
  - [ ] 응답시간 수집
  - [ ] 실패 횟수 카운팅
- [ ] 장애 처리
  - [ ] 실패 감지 (임계값 도달)
  - [ ] 재할당 요청 로직
  - [ ] 재시도 메커니즘
  - [ ] POS 비활성화 요청
- [ ] 오너 검증 API
  - [ ] 봇-POS 매칭 확인
  - [ ] 터미널 ID 검증
- [ ] SSE 상태 스트림
  - [ ] 봇 목록 및 상태
  - [ ] 응답시간 평균
  - [ ] POS 연결 상태
- [ ] 초기화 로직
  - [ ] 중앙 서버에서 활성 봇 조회
  - [ ] 용량 초과 시 비활성화
  - [ ] 인스턴스 복원

#### lotto-pos-manager (POS 매니저)
- [ ] 터미널 풀 관리
  - [ ] 사용 가능 터미널 목록
  - [ ] 할당/해제 로직
  - [ ] 동시성 처리
- [ ] 터미널 할당
  - [ ] 풀에서 터미널 선택
  - [ ] 오너 정보 등록
  - [ ] 풀 고갈 처리
- [ ] 터미널 헬스체크
  - [ ] 컨테이너 상태 확인
  - [ ] 죽은 컨테이너 감지
  - [ ] 자동 재생성
- [ ] Docker 통합
  - [ ] 컨테이너 생성/시작
  - [ ] 상태 조회
  - [ ] 컨테이너 정리
- [ ] SSE 상태 스트림
  - [ ] 전체 터미널 수
  - [ ] 사용 가능 터미널 수
  - [ ] 할당된 터미널 수

#### lotto-pos-terminal (POS 터미널)
- [ ] 오너 정보 관리
  - [ ] 오너 등록/해제
  - [ ] 오너 존재 확인
  - [ ] 매칭 검증
- [ ] 티켓 구매 API
  - [ ] 중앙 서버 호출
  - [ ] 응답시간 측정
  - [ ] 오너 검증
- [ ] 응답시간 수집
  - [ ] 시간 버퍼 관리
  - [ ] 평균 계산
  - [ ] 주기적 초기화
- [ ] 헬스체크 (POS → 봇)
  - [ ] 오너 유효성 확인
  - [ ] 불일치 시 풀 복귀
  - [ ] 봇 클라이언트 장애 처리
- [ ] 헬스체크 응답 (봇 → POS)
  - [ ] 상태 반환
  - [ ] 응답시간 제공
- [ ] 초기화 로직
  - [ ] 고유 ID 생성
  - [ ] POS 매니저 등록

#### lotto-dashboard (대시보드)
- [ ] SSE 연결 관리
  - [ ] 중앙 서버 연결
  - [ ] 봇 클라이언트 연결
  - [ ] POS 매니저 연결
- [ ] 실시간 데이터 수집
  - [ ] 회차 정보
  - [ ] 구매 현황
  - [ ] 봇 상태
  - [ ] POS 풀 상태
- [ ] 데이터 통합 및 가공
  - [ ] 여러 소스 병합
  - [ ] 통계 계산
  - [ ] 캐싱 전략
- [ ] REST API
  - [ ] 요약 정보 제공
  - [ ] 히스토리 조회
  - [ ] 필터링 옵션

---

## 포트 구성

| 모듈 | 포트 | 설명 |
|------|------|------|
| Central Server | 8100 | 중앙 관리 서버 |
| Bot Client | 8200 | 봇 클라이언트 |
| POS Manager | 8300 | 터미널 풀 관리 |
| POS Terminal | 8400+ | 구매 워커 (동적) |
| Dashboard | 8500 | 모니터링 |

---

## 구현 우선순위

### Phase 1: 기본 구조
1. lotto-core 도메인 모델
2. lotto-central-server 기본 API
3. 단일 모듈 테스트

### Phase 2: POS 시스템
1. lotto-pos-terminal 구현
2. lotto-pos-manager 풀 관리
3. POS-Central 통합 테스트

### Phase 3: 봇 시스템
1. lotto-bot-client 구현
2. Bot-POS 통합
3. 헬스체크 및 장애 처리

### Phase 4: 모니터링
1. lotto-dashboard SSE 연결
2. 실시간 데이터 시각화
3. 전체 시스템 통합

---

## 주요 고려사항

### 동시성
- 봇 인스턴스는 독립적으로 동작
- POS 풀 할당은 동시성 안전 보장
- 티켓 구매는 순차 처리

### 장애 처리
- POS 터미널 장애 시 자동 재할당
- 봇 클라이언트 재시작 시 상태 복원
- 중앙 서버 장애 시 재시도 로직

### 확장성
- POS 터미널 개수 동적 조정
- 봇 개수 환경변수로 제어
- 회차별 데이터 파티셔닝

---

## 라이선스

이 프로젝트는 학습 목적으로 만들어졌습니다.
